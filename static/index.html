<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAG Service</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0c0c0f;
    --surface: #15151a;
    --surface-2: #1c1c23;
    --border: #2a2a35;
    --border-hover: #3a3a48;
    --text: #c8c8d0;
    --text-dim: #6e6e7a;
    --text-bright: #e8e8ef;
    --accent: #4a9eff;
    --accent-dim: #2a5a9a;
    --green: #3ddc84;
    --green-dim: #1a4a2e;
    --red: #ff4a4a;
    --red-dim: #4a1a1a;
    --orange: #ffaa33;
    --mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
  }

  body {
    font-family: var(--mono);
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    line-height: 1.6;
    min-height: 100vh;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 24px;
  }

  header {
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  header h1 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-bright);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  header .subtitle {
    color: var(--text-dim);
    font-size: 12px;
    margin-top: 4px;
  }

  .status-bar {
    display: flex;
    gap: 20px;
    margin-top: 12px;
    font-size: 11px;
  }

  .status-item { color: var(--text-dim); }
  .status-item .val { color: var(--accent); font-weight: 600; }

  .status-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 6px;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  section { margin-bottom: 36px; }

  .section-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .drop-zone {
    border: 1px dashed var(--border);
    border-radius: 4px;
    padding: 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s ease;
    background: var(--surface);
  }

  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: var(--surface-2);
  }

  .drop-zone.dragover { box-shadow: inset 0 0 0 1px var(--accent-dim); }
  .drop-zone-text { color: var(--text-dim); font-size: 12px; }

  .drop-zone-text strong {
    color: var(--text);
    display: block;
    margin-bottom: 4px;
    font-size: 13px;
  }

  .drop-zone .formats {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 8px;
    letter-spacing: 0.05em;
  }

  .file-input { display: none; }
  .upload-list { margin-top: 12px; }

  .upload-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 3px;
    margin-bottom: 4px;
    font-size: 12px;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .upload-item .name { flex: 1; color: var(--text-bright); }
  .upload-item .status-text { font-size: 11px; }
  .upload-item .status-text.processing { color: var(--orange); }
  .upload-item .status-text.done { color: var(--green); }
  .upload-item .status-text.error { color: var(--red); }

  .doc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .doc-table th {
    text-align: left;
    padding: 8px 12px;
    color: var(--text-dim);
    font-weight: 500;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border-bottom: 1px solid var(--border);
  }

  .doc-table td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }

  .doc-table tr:hover td { background: var(--surface); }
  .doc-table .filename { color: var(--text-bright); font-weight: 500; }

  .badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 2px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .badge-pdf { background: var(--red-dim); color: var(--red); }
  .badge-md { background: #1a2a4a; color: #6ab0ff; }
  .badge-txt { background: #2a2a1a; color: #aaa060; }
  .badge-docx { background: #1a3a2a; color: #60aa80; }
  .badge-html { background: #3a2a1a; color: #cc8844; }

  .btn-delete {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 3px 8px;
    border-radius: 2px;
    cursor: pointer;
    font-family: var(--mono);
    font-size: 10px;
    transition: all 0.1s;
  }

  .btn-delete:hover {
    border-color: var(--red);
    color: var(--red);
    background: var(--red-dim);
  }

  .empty-state {
    text-align: center;
    padding: 24px;
    color: var(--text-dim);
    font-size: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 3px;
  }

  .search-box { display: flex; gap: 8px; margin-bottom: 12px; }

  .search-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 8px 12px;
    color: var(--text-bright);
    font-family: var(--mono);
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
  }

  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text-dim); }

  .btn-search {
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    color: var(--text-bright);
    padding: 8px 16px;
    border-radius: 3px;
    cursor: pointer;
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 600;
    transition: all 0.1s;
  }

  .btn-search:hover { background: var(--accent); color: #fff; }
  .btn-search:disabled { opacity: 0.4; cursor: not-allowed; }

  .search-meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .search-meta .time { color: var(--accent); }

  .result-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 12px;
    margin-bottom: 6px;
    animation: slideIn 0.15s ease;
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-size: 11px;
  }

  .result-source { color: var(--text-dim); }

  .result-score {
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 2px;
    font-size: 10px;
  }

  .score-high { background: var(--green-dim); color: var(--green); }
  .score-mid { background: #2a2a1a; color: var(--orange); }
  .score-low { background: var(--surface-2); color: var(--text-dim); }

  .result-text {
    color: var(--text);
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .no-results {
    text-align: center;
    padding: 16px;
    color: var(--text-dim);
    font-size: 12px;
  }

  @media (max-width: 640px) {
    .container { padding: 20px 16px; }
    .status-bar { flex-wrap: wrap; gap: 8px 16px; }
    .doc-table th:nth-child(4),
    .doc-table td:nth-child(4) { display: none; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <h1>RAG Service</h1>
    <div class="subtitle">Document ingestion &amp; vector retrieval</div>
    <div class="status-bar" id="statusBar">
      <span class="status-item"><span class="status-dot"></span>loading...</span>
    </div>
  </header>

  <section>
    <div class="section-label">Upload Documents</div>
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-text">
        <strong>Drop files here</strong>
        or click to browse
      </div>
      <div class="formats">PDF / DOCX / MD / TXT / HTML</div>
      <input type="file" class="file-input" id="fileInput" multiple
             accept=".pdf,.md,.txt,.docx,.html">
    </div>
    <div class="upload-list" id="uploadList"></div>
  </section>

  <section>
    <div class="section-label">Indexed Documents</div>
    <div id="docList"></div>
  </section>

  <section>
    <div class="section-label">Search Test</div>
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput"
             placeholder="Enter a query to test retrieval..."
             autocomplete="off">
      <button class="btn-search" id="searchBtn">Search</button>
    </div>
    <div id="searchResults"></div>
  </section>

</div>

<script>
(function() {
  var $ = function(s) { return document.querySelector(s); };

  function el(tag, attrs, children) {
    var node = document.createElement(tag);
    if (attrs) {
      Object.keys(attrs).forEach(function(k) {
        if (k === 'className') node.className = attrs[k];
        else if (k === 'textContent') node.textContent = attrs[k];
        else if (k.startsWith('on')) node.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
        else node.setAttribute(k, attrs[k]);
      });
    }
    if (children) {
      children.forEach(function(c) {
        if (typeof c === 'string') node.appendChild(document.createTextNode(c));
        else if (c) node.appendChild(c);
      });
    }
    return node;
  }

  function clear(node) { while (node.firstChild) node.removeChild(node.firstChild); }

  function formatUptime(s) {
    if (s < 60) return Math.floor(s) + 's';
    if (s < 3600) return Math.floor(s/60) + 'm';
    return Math.floor(s/3600) + 'h ' + Math.floor((s%3600)/60) + 'm';
  }

  function formatBytes(b) {
    if (!b) return '\u2014';
    if (b < 1024) return b + ' B';
    if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
    return (b/1048576).toFixed(1) + ' MB';
  }

  function statusItem(label, val) {
    var span = el('span', {className: 'status-item'});
    span.appendChild(document.createTextNode(label + ': '));
    span.appendChild(el('span', {className: 'val', textContent: val}));
    return span;
  }

  // --- Health ---
  function refreshHealth() {
    fetch('/health').then(function(r) { return r.json(); }).then(function(d) {
      var bar = $('#statusBar');
      clear(bar);
      var dot = el('span', {className: 'status-item'}, [
        el('span', {className: 'status-dot'}),
        'healthy'
      ]);
      bar.appendChild(dot);
      bar.appendChild(statusItem('docs', String(d.documents)));
      bar.appendChild(statusItem('chunks', String(d.total_chunks)));
      bar.appendChild(statusItem('model', d.embedding_model));
      bar.appendChild(statusItem('uptime', formatUptime(d.uptime_seconds)));
    }).catch(function() {
      var bar = $('#statusBar');
      clear(bar);
      bar.appendChild(el('span', {className: 'status-item', style: 'color:var(--red)', textContent: 'offline'}));
    });
  }

  // --- Document List ---
  function refreshDocuments() {
    fetch('/documents').then(function(r) { return r.json(); }).then(function(d) {
      var container = $('#docList');
      clear(container);

      if (!d.documents.length) {
        container.appendChild(el('div', {className: 'empty-state', textContent: 'No documents indexed'}));
        return;
      }

      var table = el('table', {className: 'doc-table'});
      var thead = el('thead');
      var headRow = el('tr');
      ['File', 'Chunks', 'Size', 'Indexed', ''].forEach(function(h) {
        headRow.appendChild(el('th', {textContent: h}));
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      var tbody = el('tbody');
      d.documents.forEach(function(doc) {
        var row = el('tr');
        var ext = doc.filename.split('.').pop().toLowerCase();

        // File cell: badge + filename
        var fileCell = el('td');
        fileCell.appendChild(el('span', {className: 'badge badge-' + ext, textContent: ext}));
        fileCell.appendChild(document.createTextNode(' '));
        fileCell.appendChild(el('span', {className: 'filename', textContent: doc.filename}));
        row.appendChild(fileCell);

        row.appendChild(el('td', {textContent: String(doc.chunks)}));
        row.appendChild(el('td', {textContent: formatBytes(doc.file_size_bytes)}));
        row.appendChild(el('td', {textContent: new Date(doc.indexed_at).toLocaleDateString()}));

        var actionCell = el('td');
        var deleteBtn = el('button', {
          className: 'btn-delete',
          textContent: 'delete',
          onClick: function() { deleteDoc(doc.id); }
        });
        actionCell.appendChild(deleteBtn);
        row.appendChild(actionCell);

        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }).catch(function() {
      var container = $('#docList');
      clear(container);
      container.appendChild(el('div', {className: 'empty-state', textContent: 'Error loading documents'}));
    });
  }

  // --- Delete ---
  function deleteDoc(id) {
    fetch('/documents/' + id, { method: 'DELETE' }).then(function() {
      refreshDocuments();
      refreshHealth();
    });
  }

  // --- Upload ---
  var dropZone = $('#dropZone');
  var fileInput = $('#fileInput');

  dropZone.addEventListener('click', function() { fileInput.click(); });

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', function() {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener('change', function() {
    handleFiles(fileInput.files);
    fileInput.value = '';
  });

  function handleFiles(files) {
    if (!files.length) return;
    var list = $('#uploadList');

    Array.from(files).forEach(function(file) {
      var item = el('div', {className: 'upload-item'}, [
        el('span', {className: 'name', textContent: file.name}),
        el('span', {className: 'status-text processing', textContent: 'uploading...'})
      ]);
      list.insertBefore(item, list.firstChild);

      var statusEl = item.querySelector('.status-text');

      var fd = new FormData();
      fd.append('files', file);

      statusEl.textContent = 'processing...';
      fetch('/upload', { method: 'POST', body: fd })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(err) { throw new Error(err.detail || r.statusText); });
          return r.json();
        })
        .then(function(d) {
          var doc = d.documents[0];
          statusEl.textContent = doc.chunks + ' chunks';
          statusEl.className = 'status-text done';
          refreshDocuments();
          refreshHealth();
        })
        .catch(function(e) {
          statusEl.textContent = e.message;
          statusEl.className = 'status-text error';
        });
    });
  }

  // --- Search ---
  var searchInput = $('#searchInput');
  var searchBtn = $('#searchBtn');

  searchBtn.addEventListener('click', doSearch);
  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doSearch();
  });

  function doSearch() {
    var query = searchInput.value.trim();
    if (!query) return;

    searchBtn.disabled = true;
    searchBtn.textContent = '...';
    var resultsEl = $('#searchResults');

    fetch('/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: query, top_k: 5 })
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      clear(resultsEl);

      if (!d.results.length) {
        resultsEl.appendChild(el('div', {className: 'no-results', textContent: 'No matching chunks found'}));
        return;
      }

      var meta = el('div', {className: 'search-meta'}, [
        d.results.length + ' results in ',
        el('span', {className: 'time', textContent: d.query_time_ms + 'ms'})
      ]);
      resultsEl.appendChild(meta);

      d.results.forEach(function(r) {
        var scoreClass = r.score >= 0.7 ? 'score-high' : r.score >= 0.4 ? 'score-mid' : 'score-low';
        var scoreDisplay = (r.score * 100).toFixed(1) + '%';
        var textPreview = r.text.length > 500 ? r.text.substring(0, 500) + '...' : r.text;

        var item = el('div', {className: 'result-item'}, [
          el('div', {className: 'result-header'}, [
            el('span', {className: 'result-source', textContent: r.filename + ' / chunk ' + r.chunk_index}),
            el('span', {className: 'result-score ' + scoreClass, textContent: scoreDisplay})
          ]),
          el('div', {className: 'result-text', textContent: textPreview})
        ]);
        resultsEl.appendChild(item);
      });
    })
    .catch(function(e) {
      clear(resultsEl);
      resultsEl.appendChild(el('div', {className: 'no-results', style: 'color:var(--red)', textContent: 'Error: ' + e.message}));
    })
    .finally(function() {
      searchBtn.disabled = false;
      searchBtn.textContent = 'Search';
    });
  }

  // --- Init ---
  refreshHealth();
  refreshDocuments();
  setInterval(refreshHealth, 30000);
})();
</script>
</body>
</html>
